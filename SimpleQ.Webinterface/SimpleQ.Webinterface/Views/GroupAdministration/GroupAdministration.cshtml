@using SimpleQ.Webinterface.Properties;
@using SimpleQ.Webinterface.Models;
@model SimpleQ.Webinterface.Models.ViewModels.GroupAdministrationModel

<div class="row pl-4 mt-1 ml-0 mr-0">
    <h2>@Resources.groupAdministrationHeader</h2>
</div>
<div class="row mt-1 pl-3 ml-0 mr-0">
    <div class="col-md-4 pr-0">
        <h4 class="text-center">Gruppenauswahl</h4>
        <div class="form-group mt-2 mb-1">
            <label for="groups">@Resources.groups</label>
            <div class="border border-dark">
                <ul class="list-group ga-groups-ul pl-2" id="gaGroups">
                    @foreach (Department d in Model.Departments)
                    {
                        <li>
                            <input name="groups" type="radio" value="@d.DepId"> <a>@d.DepName</a>
                        </li>
                    }
                </ul>
            </div>
        </div>
        <span>Gewählte Gruppe: <b id="chosenGroup"></b></span>
        <button type="button" class="btn btn-primary btn-block mt-3" id="showNewGroupModalBtn">Neue Gruppe erstellen</button>
    </div>
    <div class="col-md-3">
        <h4 class="text-center">Aktionen</h4>
        <label>Name</label>
        <div class="row mr-0 ml-0" id="newCategoryDiv">
            <div class="col-10 p-0">
                <input class="form-control rightNotRounded withoutBorder" id="groupNameInput" readonly type="text" />
            </div>
            <div class="col-2 p-0">
                <button type="button" class="btn btn-success btn-block pb-0 pl-0 pr-0 leftNotRounded" onclick="editGroupName(this)"><i class="material-icons">&#xe150;</i></button>
            </div>
        </div>


        <button class="btn btn-primary btn-block mt-2" onclick="openMailDiv()"><span class="d-flex justify-content-between"><span>Mitglieder einladen</span><i id="inviteMatesIcon" class="material-icons">&#xe01f;</i></span></button>
        <button class="btn btn-danger btn-block mt-2"><span class="d-flex justify-content-between"><span>Gruppe löschen</span><i class="material-icons">	&#xe92b;</i></span></button>

    </div>
    <div class="col-md-5 border-left" id="mailDiv">
        <h4 class="text-center">Infos</h4>

        <label>@Resources.subject</label>
        <input class="form-control" type="text" placeholder="@Resources.invitationToSimpleQ"/>

        <label class="mt-2 mb-0">@Resources.content</label>
        <div id="textEditorDiv" class="textEditor"></div>
        <button class="btn btn-primary btn-block mt-2"><span class="d-flex justify-content-between"><span>Email versenden</span><i id="openAddAnswerUpDownIcon" class="material-icons">&#xe0d0;</i></span></button>

    </div>
</div>



@* Down here its modal code *@
<div class="modal" id="newGroupModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title">New Group..</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <label for="NewGroupTB">Name of the group</label>
                <input id="NewGroupTB" type="text" class="form-control" />
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="addNewGroup()">Create</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Abort</button>
            </div>

        </div>
    </div>
</div>

<script>
    let groups = {};
    let chosenId = 0;
    let chosen;


    $(function () { // <-- Things to do at startup

        mailEditorStartup();

        @{
            foreach(Department d in Model.Departments)
            {
                @:groups['@d.DepId'] = '@d.DepName';
            }
        }

        //choose first group automatically
        let radioBtnElem = document.getElementById("gaGroups").children[0].children[0];
        radioBtnElem.setAttribute("checked", "checked");
        updateGroupNameInput(radioBtnElem.parentElement.children[1].innerHTML); //fill into Textbox

        $("input[type=radio]").click(function () {
            handleCheckedAttributes(this);
            let text = this.parentElement.children[1].innerHTML;
            chosenId = this.value;
            updateGroupNameInput(text);
        });

        $("#showNewGroupModalBtn").click(function () {
            $("#newGroupModal").modal("show");
        });
    }); // <-- Things to to at startup END

    function handleCheckedAttributes(elem) {
        let list = document.getElementById("gaGroups").children;

        for (let i = 0; i < list.length; i++) {
            if (list[i].children[0] !== elem) {
                list[i].children[0].removeAttribute("checked");
            }
        }
        elem.setAttribute("checked", "checked");
    }

    function addNewGroup() {
        let groupName = document.getElementById("NewGroupTB").value;

        if (groupName == "") {
            alert("@Resources.invalidInput");
            return;
        }

        let values = Object.values(groups);
        if (values.includes(groupName)) {
            alert('@Resources.groupAlreadyExists');
            return;
        }

        let url = '@Url.Action("Create", "GroupAdministration", new { depName = "temp"})'.replace("temp", groupName);

        $.get(
            url,
            function (id) {
                let groupsUl = document.getElementById("gaGroups");
                groupsUl.innerHTML +=
                    '<li>' +
                    '<input name="groups" type="radio" value="' + id + '">' +
                    groupName +
                    '</li>';

                updateGroupNameInput(groupName);

                //$("input[type=radio][value=" + id + "]").prop("checked", true);

            }
        );
    }

    function updateGroupNameInput(groupName) {
        document.getElementById("groupNameInput").value = groupName;
        document.getElementById("chosenGroup").innerHTML = groupName;
    }

    if (typeof tempTextGroups === 'undefined') {
        let tempTextGroups;
    }

    function editGroupName(button) {
        //let input = document.getElementById("groupNameInput");
        $("#groupNameInput").removeClass("withoutBorder").removeAttr("readonly");
        let text = button.parentElement.parentElement.children[0].children[0].value;
        tempTextGroups = text;
        button.parentElement.parentElement.children[0].classList.remove("col-10");
        button.parentElement.parentElement.children[0].classList.add("col-8");
        button.parentElement.parentElement.children[1].classList.remove("col-2");
        button.parentElement.parentElement.children[1].classList.add("col-4");
        let edit =
            '       <span class="row ml-0 mr-0">' +
            '           <span class="col-6 p-0">' +
            '               <button type="button" class="btn btn-success btn-block m-0 pb-0 pl-0 pr-0 leftNotRounded rightNotRounded" onclick="saveGroup(this,false,\'' + text + '\')"><i class="material-icons">&#xe5ca;</i></button>' +
            '           </span>' +
            '           <span class="col-6 p-0">'  +
            '               <button type="button" class="btn btn-secondary btn-block m-0 pb-0 pl-0 pr-0 leftNotRounded" onclick="saveGroup(this,true,\'' + text + '\')"><i class="material-icons">&#xe5cd;</i></button>' +
            '           </span>' +
            '       </span>';
        button.parentElement.innerHTML = edit;
    }

    function saveGroup(button, canceled, tempText) {
        let text;
        if (canceled) {
            //text = tempTextGroups;
            document.getElementById("groupNameInput").value=tempTextGroups;
        } else {
            text = document.getElementById("groupNameInput").value;
            let values = Object.values(groups);
            if (values.includes(text)) {
                alert('@Resources.groupAlreadyExists');
                return;
            }


            let url = '@Url.Action("Modify", "GroupAdministration")'//, new {depId = "temp1", depName = "temp2"})'.replace("temp1", groups[tempTextGroups]).replace("temp2", text);
            url += '?depId=' + groups[tempTextGroups] + '&depName=' + text;
            $("#groupAdministrationWindow").load(url, function () {
                chosen = text;
            });

            //updateGroups();
        }
        $("#groupNameInput").attr("readonly", true);
        $("#groupNameInput").addClass("withoutBorder");

        button.parentElement.parentElement.parentElement.parentElement.children[0].classList.remove("col-8");
        button.parentElement.parentElement.parentElement.parentElement.children[0].classList.add("col-10");
        button.parentElement.parentElement.parentElement.parentElement.children[1].classList.remove("col-4");
        button.parentElement.parentElement.parentElement.parentElement.children[1].classList.add("col-2");

        let edited = '<button type="button" class="btn btn-success btn-block pb-0 pl-0 pr-0 leftNotRounded" onclick="editGroupName(this)"><i class="material-icons">&#xe150;</i></button>';
        tempTextGroups = "";
        button.parentElement.parentElement.parentElement.parentElement.children[1].innerHTML = edited;
    }

    function mailEditorStartup() {
        $("#mailDiv").hide();
        $("#textEditorDiv").trumbowyg({
            lang: '@Resources.textEditorLanguage'
        });
        $('#mailDiv').trumbowyg('html', "<p>@Resources.downloadAppHere</p><a href='#'>https://play.google.com/store/apps/details?id=com.ubisoft.accovenant</a>");
    }

    function openMailDiv() {
        if ($("#mailDiv").is(":hidden")) {
            $("#mailDiv").show('slide', { direction: 'left' }, 500);
            document.getElementById("inviteMatesIcon").innerHTML = "&#xe020;";
        } else {
            $("#mailDiv").hide('slide', { direction: 'left' }, 500);
            document.getElementById("inviteMatesIcon").innerHTML = "&#xe0d0;";
        }
        
    }

</script>