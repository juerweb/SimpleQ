@using SimpleQ.Webinterface.Properties;
@{
    Layout = "~/Views/Shared/_AccountLayout.cshtml";
}

@if (ViewBag.confirmed == true)
{
    <div class="alert alert-success">
        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
        <strong>@Resources.emailConfirmed!</strong> @Resources.youCanNowLogin.
    </div>
}

<a class="btn btn-primary" href="@Url.Action("Register", "Account")">@Resources.goToRegistration</a>
<br /><br />
@using (Html.BeginForm("Login", "Account"))
{
    <div style="background-color:rgba(255, 255, 255,0.7)" class="p-4 mb-2">
        <div class="form-group">
            @Html.Label("custCode", Resources.customerCode)
            @Html.TextBox("custCode", "", new { @class = "form-control", @Value = ViewBag.custCode ?? "" })
            @Html.ValidationMessage("custCode")
        </div>

        <div class="form-group">
            @Html.Label("password", Resources.password)
            @Html.Password("password", "", new { @class = "form-control" })
            @Html.ValidationMessage("password")
        </div>

        <div class="form-group form-check">
            <label for="remember" class="form-check-label">
                @Html.CheckBox("remember", false, new { @class = "form-check-input" }) @Resources.stayLoggedIn
            </label>
        </div>
        @Html.AntiForgeryToken()
        <div class="row">
            <div class="col-6">
                <button type="submit" class="btn btn-primary btn-block">@Resources.login</button>
            </div>
            <div class="col-6">
                <a id="forgotPwdBtn" href="#">@Resources.forgotPassword</a>
            </div>
        </div>
    </div>
}

<div id="resetPwdDiv" style="display: none">
    <div style="background-color:rgba(255, 255, 255,0.7)" class="p-4 mb-2">
        <div class="form-group">
            <label for="resCustCode">@Resources.customerCode</label>
            <input id="resCustCode" class="form-control" />
        </div>
        <button type="button" class="btn btn-primary" id="sendResetBtn">@Resources.sendResetLink</button>
        <br />
        <span id="msg"></span>
    </div>
</div>
@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "__AjaxAntiForgeryForm" }))
{
    @Html.AntiForgeryToken()
}

<script>
    $(function () {
        setLoginBackground();

        //jQuery plugin to prevent double submission of forms
        $.fn.preventDoubleSubmission = function () {
            $(this).on('submit', function (e) {
                let $form = $(this);

                if ($form.data('submitted') === true) {
                    // Previously submitted - don't submit again
                    e.preventDefault();
                } else {
                    // Mark it so that the next submit can be ignored
                    $form.data('submitted', true);
                }
            });

            // Keep chainability
            return this;
        };

        $("form").preventDoubleSubmission();

        $("#forgotPwdBtn").click(function () {
            $("#resetPwdDiv").toggle();
        });

        $("#sendResetBtn").click(function () {
            let clicked = false;
            if (!clicked) {
                clicked = true;

                let form = $("#__AjaxAntiForgeryForm");
                let token = $('input[name="__RequestVerificationToken"]', form).val();
                let custCode = encodeURIComponent($("#resCustCode").val());

                $.ajax({
                    method: "POST",
                    url: "@Url.Action("ForgotPassword", "Account")",
                    data: {
                        "__RequestVerificationToken": token,
                        "custCode": custCode,
                    },
                    statusCode: {
                        200: function () {
                            $("#msg").text("@Resources.EmailSent");
                        },
                        404: function () {
                            $("#msg").text("@Resources.InvalidCustCode");
                        },
                        503: function () {
                            $("#msg").text("@Resources.EmailSendingFailed");
                        }
                    }
                });
            }
        });
    });

    function setLoginBackground() {
        let rand = Math.floor((Math.random() * 11) + 1);
        $("body").css("background-image", "url('../../Content/Images/loginBG" + rand + ".jpg')");
    }
</script>
