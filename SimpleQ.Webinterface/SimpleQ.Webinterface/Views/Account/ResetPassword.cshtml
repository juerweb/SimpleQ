@using SimpleQ.Webinterface.Properties
@{
    Layout = "~/Views/Shared/_AccountLayout.cshtml";
}

<h3>@Resources.resetPassword</h3>
<div style="background-color:rgba(255, 255, 255,0.7)" class="p-4 mb-2">
    <div>
        <div class="form-group">
            <label for="password">@Resources.password</label>
            <input type="password" id="password" class="form-control" />
        </div>

        <div class="form-group">
            <label for="confirmPassword">@Resources.confirmPassword</label>
            <input type="password" id="confirmPassword" class="form-control" />
        </div>

        <button type="button" class="btn btn-primary" id="savePwd">@Resources.SavePassword</button>
    </div>
    <br />
    <span id="msg"></span>
    <br />
    <a class="btn btn-primary" href="@Url.Action("Login", "Account")" style="display: none" id="toLogin">@Resources.ToLogin</a>
    @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "__AjaxAntiForgeryForm" }))
    {
        @Html.AntiForgeryToken()
    }
</div>

<script>
    $(function () {
        $("body").css("background-image", "url('../../Content/Images/registrationBG.jpg')");

        let clicked = false;
        $("#savePwd").click(function () {
            if (!clicked) {
                if ($("#password").val() == $("#confirmPassword").val()) {
                    clicked = true;
                    let form = $("#__AjaxAntiForgeryForm");
                    let token = $('input[name="__RequestVerificationToken"]', form).val();
                    $.ajax({
                        method: "PUT",
                        url: "@Url.Action("ChangePassword", "Account")",
                        data: {
                            "__RequestVerificationToken": token,
                            "authToken": "@ViewBag.authToken",
                            "password": $("#password").val()
                        },
                        statusCode: {
                            200: function () {
                                $("#msg").text("@Resources.PasswordChanged");
                                $("#toLogin").show();
                            },
                            409: function () {
                                $("#msg").text("@Resources.InvalidLink");
                            }
                        }
                    });
                } else {
                    $("#msg").text("@Resources.PasswordsDontMatch");
                }
            }
        });
    });
</script>